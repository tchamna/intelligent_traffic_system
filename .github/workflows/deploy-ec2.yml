name: Deploy to EC2

'on':
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      EC2_SSH_PORT: ${{ secrets.EC2_SSH_PORT }}
      EC2_APP_PORT: ${{ secrets.EC2_APP_PORT }}
      EC2_PORT_RANGE_START: ${{ secrets.EC2_PORT_RANGE_START }}
      EC2_PORT_RANGE_END: ${{ secrets.EC2_PORT_RANGE_END }}
      NGINX_SERVER_NAME: ${{ secrets.NGINX_SERVER_NAME }}
      NGINX_SITE_NAME: ${{ secrets.NGINX_SITE_NAME }}
      TORCH_INDEX_URL: ${{ secrets.TORCH_INDEX_URL }}
      NGINX_DISABLE_CONFLICTS: ${{ secrets.NGINX_DISABLE_CONFLICTS }}
      ENABLE_CERTBOT: ${{ secrets.ENABLE_CERTBOT }}
      CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}
      NGINX_REDIRECT_TO_HTTPS: ${{ secrets.NGINX_REDIRECT_TO_HTTPS }}
    steps:
      - name: Deploy over SSH
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${EC2_HOST:-}" ] || [ -z "${EC2_USER:-}" ] || [ -z "${EC2_SSH_KEY:-}" ]; then
            echo "Missing required secrets: EC2_HOST, EC2_USER, EC2_SSH_KEY"
            exit 1
          fi

          mkdir -p ~/.ssh
          printf "%s" "$EC2_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          SSH_PORT="${EC2_SSH_PORT:-22}"
          APP_PORT="${EC2_APP_PORT:-}"
          PORT_RANGE_START="${EC2_PORT_RANGE_START:-8001}"
          PORT_RANGE_END="${EC2_PORT_RANGE_END:-8999}"
          NGINX_SERVER_NAME="${NGINX_SERVER_NAME:-_}"
          NGINX_SITE_NAME="${NGINX_SITE_NAME:-intelligent_traffic_system}"
          NGINX_DISABLE_CONFLICTS="${NGINX_DISABLE_CONFLICTS:-1}"
          ENABLE_CERTBOT="${ENABLE_CERTBOT:-0}"
          CERTBOT_EMAIL="${CERTBOT_EMAIL:-}"
          NGINX_REDIRECT_TO_HTTPS="${NGINX_REDIRECT_TO_HTTPS:-0}"

          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            "${EC2_USER}@${EC2_HOST}" \
            "APP_PORT='${APP_PORT}' PORT_RANGE_START='${PORT_RANGE_START}' PORT_RANGE_END='${PORT_RANGE_END}' NGINX_SERVER_NAME='${NGINX_SERVER_NAME}' NGINX_SITE_NAME='${NGINX_SITE_NAME}' NGINX_DISABLE_CONFLICTS='${NGINX_DISABLE_CONFLICTS}' ENABLE_CERTBOT='${ENABLE_CERTBOT}' CERTBOT_EMAIL='${CERTBOT_EMAIL}' NGINX_REDIRECT_TO_HTTPS='${NGINX_REDIRECT_TO_HTTPS}' bash -s" <<'REMOTE_EOF'
          set -euo pipefail
          APP_DIR="$HOME/apps/intelligent_traffic_system"
          REPO_URL="https://github.com/tchamna/intelligent_traffic_system.git"
          PYTHON_BIN="python3"
          PORT="${APP_PORT:-}"
          PORT_RANGE_START="${PORT_RANGE_START:-8001}"
          PORT_RANGE_END="${PORT_RANGE_END:-8999}"
          NGINX_SERVER_NAME="${NGINX_SERVER_NAME:-_}"
          NGINX_SITE_NAME="${NGINX_SITE_NAME:-intelligent_traffic_system}"
          NGINX_DISABLE_CONFLICTS="${NGINX_DISABLE_CONFLICTS:-1}"
          ENABLE_CERTBOT="${ENABLE_CERTBOT:-0}"
          CERTBOT_EMAIL="${CERTBOT_EMAIL:-}"
          NGINX_REDIRECT_TO_HTTPS="${NGINX_REDIRECT_TO_HTTPS:-0}"
          TORCH_INDEX_URL="${TORCH_INDEX_URL:-https://download.pytorch.org/whl/cpu}"
          PIP_ENV="PIP_NO_CACHE_DIR=1"
          if [ -n "$TORCH_INDEX_URL" ]; then
            PIP_ENV="$PIP_ENV PIP_EXTRA_INDEX_URL=$TORCH_INDEX_URL"
          fi

          port_in_use() {
            local port="$1"
            if command -v ss >/dev/null 2>&1; then
              ss -ltn 2>/dev/null | awk 'NR>1 {print $4}' | sed 's/.*://' | grep -qx "$port"
              return $?
            fi
            if command -v netstat >/dev/null 2>&1; then
              netstat -ltn 2>/dev/null | awk 'NR>1 {print $4}' | sed 's/.*://' | grep -qx "$port"
              return $?
            fi
            return 1
          }

          port_used_by_its_service() {
            local port="$1"
            local pid=""
            pid="$(systemctl show -p MainPID --value its.service 2>/dev/null || true)"
            if [ -z "$pid" ] || [ "$pid" = "0" ]; then
              return 1
            fi
            if command -v ss >/dev/null 2>&1; then
              ss -ltnp 2>/dev/null | awk -v p=":$port" -v pid="pid=$pid" '$0 ~ p && $0 ~ pid {found=1} END {exit !found}'
              return $?
            fi
            if command -v netstat >/dev/null 2>&1; then
              netstat -ltnp 2>/dev/null | awk -v p=":$port" -v pid="/$pid" '$0 ~ p && $0 ~ pid {found=1} END {exit !found}'
              return $?
            fi
            return 1
          }

          if [ ! -d "$APP_DIR/.git" ]; then
            mkdir -p "$HOME/apps"
            git clone "$REPO_URL" "$APP_DIR"
          fi

          cd "$APP_DIR"
          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          if [ ! -d ".venv" ]; then
            $PYTHON_BIN -m venv .venv
          fi
          . .venv/bin/activate
          rm -rf ~/.cache/pip
          env $PIP_ENV pip install --upgrade pip
          env $PIP_ENV pip install --prefer-binary -r requirements.txt
          deactivate

          if [ -n "$PORT" ] && [ "$PORT" != "auto" ] && [ "$PORT" != "0" ]; then
            if port_in_use "$PORT" && ! port_used_by_its_service "$PORT"; then
              echo "APP_PORT=$PORT is already in use by another process."
              exit 1
            fi
          fi

          if [ -z "$PORT" ] || [ "$PORT" = "auto" ] || [ "$PORT" = "0" ]; then
            if [ -f /etc/its.env ]; then
              PORT="$(grep -E '^PORT=' /etc/its.env | tail -1 | cut -d= -f2)"
              if [ -n "$PORT" ] && echo "$PORT" | grep -q '[^0-9]'; then
                echo "Invalid PORT value '$PORT' in /etc/its.env. Selecting a free port."
                PORT=""
              fi
              if [ -n "$PORT" ] && port_in_use "$PORT" && ! port_used_by_its_service "$PORT"; then
                echo "Port $PORT from /etc/its.env is in use by another process. Selecting a free port."
                PORT=""
              fi
            fi
          fi

          if [ -z "$PORT" ] || [ "$PORT" = "auto" ] || [ "$PORT" = "0" ]; then
            for p in $(seq "$PORT_RANGE_START" "$PORT_RANGE_END"); do
              if port_in_use "$p"; then
                continue
              fi
              PORT="$p"
              break
            done
          fi

          if [ -z "$PORT" ] || echo "$PORT" | grep -q '[^0-9]'; then
            echo "Failed to find a free port."
            exit 1
          fi

          sudo tee /etc/its.env >/dev/null <<ITS_ENV
          PORT=$PORT
          MODEL=yolov8l.pt
          CONF=0.2
          THRESHOLD=5
          YELLOW_DURATION=3.0
          SMOOTHING_WINDOW=2.0
          ITS_ENV

          sudo tee /etc/systemd/system/its.service >/dev/null <<ITS_SERVICE
          [Unit]
          Description=Intelligent Traffic System
          After=network.target

          [Service]
          Type=simple
          User=ec2-user
          WorkingDirectory=/home/ec2-user/apps/intelligent_traffic_system
          EnvironmentFile=/etc/its.env
          ExecStart=/home/ec2-user/apps/intelligent_traffic_system/.venv/bin/uvicorn service:app --host 0.0.0.0 --port ${PORT}
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target
          ITS_SERVICE

          sudo systemctl daemon-reload
          sudo systemctl enable its.service
          sudo systemctl restart its.service
          sudo systemctl status its.service --no-pager -l

          if ! command -v nginx >/dev/null 2>&1; then
            if command -v yum >/dev/null 2>&1; then
              sudo yum install -y nginx
            elif command -v apt-get >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y nginx
            else
              echo "Nginx not installed and no package manager found."
              exit 1
            fi
          fi

          if [ "$NGINX_DISABLE_CONFLICTS" = "1" ] && [ "$NGINX_SERVER_NAME" != "_" ]; then
            matches="$(sudo grep -RIl "server_name[[:space:]].*${NGINX_SERVER_NAME}" /etc/nginx/conf.d || true)"
            ts="$(date +%Y%m%d%H%M%S)"
            for f in $matches; do
              if [ -f "$f" ] && [ "$f" != "/etc/nginx/conf.d/${NGINX_SITE_NAME}.conf" ]; then
                case "$f" in
                  *.bak.*) continue ;;
                esac
                sudo mv "$f" "${f}.bak.${ts}"
              fi
            done
          fi

          sudo mkdir -p /var/www/certbot
          sudo tee "/etc/nginx/conf.d/${NGINX_SITE_NAME}.conf" >/dev/null <<NGINX_CONF
          server {
              listen 80;
              server_name ${NGINX_SERVER_NAME};
              client_max_body_size 25m;

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              location / {
                  proxy_pass http://127.0.0.1:${PORT};
                  proxy_http_version 1.1;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_read_timeout 120s;
              }
          }
          NGINX_CONF

          sudo nginx -t
          sudo systemctl enable nginx
          sudo systemctl restart nginx
          sudo systemctl status nginx --no-pager -l

          if [ "$ENABLE_CERTBOT" = "1" ]; then
            if [ -z "$CERTBOT_EMAIL" ] || [ "$NGINX_SERVER_NAME" = "_" ]; then
              echo "ENABLE_CERTBOT=1 requires CERTBOT_EMAIL and a real server name."
              exit 1
            fi
            if ! command -v certbot >/dev/null 2>&1; then
              if command -v yum >/dev/null 2>&1; then
                sudo yum install -y certbot python3-certbot-nginx
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y certbot python3-certbot-nginx
              else
                echo "Certbot not installed and no package manager found."
                exit 1
              fi
            fi

            REDIRECT_FLAG=""
            if [ "$NGINX_REDIRECT_TO_HTTPS" = "1" ]; then
              REDIRECT_FLAG="--redirect"
            fi
            sudo certbot --nginx -d "$NGINX_SERVER_NAME" --non-interactive --agree-tos -m "$CERTBOT_EMAIL" $REDIRECT_FLAG
            sudo nginx -t
            sudo systemctl reload nginx
          fi

          echo "Deployed: http://${NGINX_SERVER_NAME}/"
          echo "Direct port: ${PORT}"
          REMOTE_EOF
